{% extends "base.html" %}

{% block title %}
    Search results
{% endblock %}

{% block content %}
<div class="row">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">All</a></li>
            <li class="breadcrumb-item">Search</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-md">
        <div class="row">
            <div class="col">
                <h2>Search results</h2>
            </div>
        </div>

        <form id="entity-form">
            <div class="row">
                <div class="col-md">
                    <div class="input-group">
                        <input type="text" id="entity-lookup" class="form-control form-control-lg" placeholder="Cook County" value="{{ request.GET.get('name', '') }}" />
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-button">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div class="row mb-4 mt-3">
            <div class="col ml-2">
                <strong>Result type:</strong> <a class="{% if 'entity_type' in request.GET and request.GET['entity_type'] == 'unit' %}bg-light{% endif %} p-1 rounded" href="{{ request.path }}?entity_type=unit&{{ request|query_transform(drop_keys=['entity_type', 'page']) }}"><i class="fas fa-building"></i> Unit</a> &nbsp;
                <a class="{% if 'entity_type' in request.GET and request.GET['entity_type'] == 'department' %}bg-light{% endif %} p-1" href="{{ request.path }}?entity_type=department&{{ request|query_transform(drop_keys=['entity_type', 'page']) }}"><i class="far fa-building"></i> Department</a> &nbsp;
                <a class="{% if 'entity_type' in request.GET and request.GET['entity_type'] == 'person' %}bg-light{% endif %} p-1" href="{{ request.path }}?entity_type=person&{{ request|query_transform(drop_keys=['entity_type', 'page']) }}"><i class="far fa-address-card"></i> Person</a> &nbsp;
                <a class="{% if 'entity_type' not in request.GET %}bg-light{% endif %} p-1 rounded" href="{{ request.path }}?{{ request|query_transform(drop_keys=['entity_type', 'page']) }}"><i class="fas fa-globe"></i> All</a> &nbsp;
                {% set drop_keys=request.GET.keys() | reject('in', ['entity_type', 'name']) | list %}
                <a class="p-1 text-danger" href="{{ request.path }}?{{ request|query_transform(drop_keys=drop_keys) }}"><i class="fas fa-times"></i> Clear filters</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                {% if request.GET.entity_type %}
                    {% set requested_entities = request.GET.entity_type.split(',') %}
                {% else %}
                    {% set requested_entities = ['unit', 'department', 'person'] %}
                {% endif %}
                {% for entity_type, entity_facets in facets.items() if entity_type in requested_entities %}
                    <div id="accordian">
                        <div class="card mb-3">
                            <div class="card-header bg-warning">
                                <h5>
                                    Filter <strong>{{ entity_type.title() }}</strong> by
                                    <button id="{{ entity_type }}-facet-toggle" class="btn btn-sm btn-link float-right" align="right" data-toggle="collapse" data-target="#{{ entity_type }}-facets" aria-expanded="{% if requested_entities|length > 1 %}false{% else %}true{% endif %}">
                                        {% if requested_entities|length > 1 %}
                                            <i class="fa fa-chevron-circle-down" aria-hidden="true"></i>
                                            Expand
                                        {% else %}
                                            <i class="fa fa-chevron-circle-up" aria-hidden="true"></i>
                                            Collapse
                                        {% endif %}
                                    </button>
                                </h5>
                            </div>
                            <div class="collapse {% if requested_entities|length > 1 %}collapsed{% else %}show{% endif %}" id="{{ entity_type }}-facets" data-parent="#accordion">
                                <ul class="list-group list-group-flush">
                                    {% for facet, value_counts in entity_facets.items() %}
                                        <li class="list-group-item">
                                            {% with current_facet=facet.split(',')[0]|param_from_index %}
                                                <strong>{{ current_facet.title() }}</strong><br />

                                                {% for vc in value_counts %}
                                                    <a href="/search/?{% if not requested_entities %}entity_type={{ entity_type }}&{% endif %}{{ [(facet.split(',')[0], vc.value)]|url_from_facet(request) }}">
                                                        {% if current_facet in ('employer', 'parent') %}
                                                            {{ vc.value|employer_from_slug }}
                                                        {% elif current_facet in ('headcount', 'salary', 'expenditure') %}
                                                            {{ vc.value|format_range }}
                                                        {% else %}
                                                            {{ vc.value }}
                                                        {% endif %}
                                                    </a>
                                                    <span class="badge badge-pill badge-light float-right">{{ vc.count }}</span><br />

                                                    {% if vc.get('pivot') %}
                                                        <div class="pivot ml-4">
                                                        {% for pc in vc.pivot %}
                                                            <a href="/search/?{% if not requested_entities %}entity_type={{ entity_type }}&{% endif %}{{ [(facet.split(',')[0], vc.value), (facet.split(',')[-1], pc.value)]|url_from_facet(request) }}">{{ pc.value }}</a> <span class="badge badge-pill badge-light float-right">{{ pc.count }}</span><br />
                                                        {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endwith %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="col-md-8">
                <div class="card search-results">
                    {% if results %}
                        <table class="table table-hover">
                            <tbody>
                                {% for result in results %}
                                    <tr>
                                        <td>
                                            {{ loop.index0 + page_obj.start_index() }}.
                                            {% include 'partials/search_result.html' %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="card-body">
                            <h4>No results match your query.</h4>
                            Enter a different search term, <a href="{{ request.path }}?{{ request|query_transform(drop_keys=drop_keys) }}">clear your filters</a> or select a different facet to try again.
                        </div>
                    {% endif %}
                </div>
                {% include 'partials/pagination.html' %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<div class="modal" tabindex="-1" role="dialog" id="signupModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <h3>Signup form goes here</h3>
                <p>
                    <a href="javascript://" class="toggle-login-signup" data-parent_modal="signupModal">
                        Already have an account?
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
<div class="modal" tabindex="-1" role="dialog" id="loginModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <h3>Login form goes here</h3>
                <p>
                    <a href="javascript://" class="toggle-login-signup" data-parent_modal="loginModal">
                        Need to create an account?
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script type="text/javascript">
    {% if request.session.search_count > 3 %}
        $('#signupModal').modal();
        $('.toggle-login-signup').on('click', function(e){
            var parent_modal = $(e.target).data('parent_modal');

            if (parent_modal == 'loginModal'){
                $('#loginModal').modal('hide');
                $('#signupModal').modal();
            } else {
                $('#signupModal').modal('hide');
                $('#loginModal').modal();
            }
        })
    {% else %}
    $('#submit-button').click(function submitSearch(e) {
        e.preventDefault();

            var url;

            var params = {{ request.GET.dict()|safe }};

            if ( $('#entity-lookup').val() ) {
                params['name'] = $('#entity-lookup').val();
            }

            delete params.page;

            var querystring = $.param(params);

            if ( $('#entity-lookup').val() ) {
                url = '/search/?' + querystring;
            } else {
                url = '/search/';
            }

            window.location = url;

    });
    {% endif %}

    $('[id*="facet-toggle"]').click(function toggleClick(e) {
        // On click, content has not yet been expanded, i.e., if aria-expanded
        // is false, the element is about to be expanded, so we need to update
        // the button to collapse accordingly.
        var expanding = $(this).attr('aria-expanded') == 'false';

        var expand_text = '<i class="fa fa-chevron-circle-down" aria-hidden="true"></i> Expand';
        var collapse_text = '<i class="fa fa-chevron-circle-up" aria-hidden="true"></i> Collapse';

        if (expanding) {
            $(this).html(collapse_text);
        } else {
            $(this).html(expand_text);
        }
    });
</script>
{% endblock %}
