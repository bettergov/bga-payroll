{% extends "base.html" %}

{% block title %}
    Search results
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">All</a></li>
        <li class="breadcrumb-item">Search</li>
    </ol>
</nav>

<div class="col-md-12">
    <div class="row">
        <div class="col">
            <h2>Search results</h2>
        </div>
    </div>

    <form id="entity-form">
        <div class="row">
            <div class="col-10">
                <input type="text" id="entity-lookup" class="form-control form-control-lg" placeholder="Chicago" />
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submit-button" style="width:100%;">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
    </form>

    <div class="row mb-3 mt-3">
        <div class="col">
            Filter by: <a class="badge {% if 'entity_type' in request.GET and request.GET['entity_type'] == 'unit' %}badge-primary{% else %}badge-light{% endif %}" href="{{ request.path }}?entity_type=unit&{{ request|query_transform(drop_keys=['entity_type']) }}"><i class="fas fa-building"></i> Unit</a>
            <a class="badge {% if 'entity_type' in request.GET and request.GET['entity_type'] == 'department' %}badge-primary{% else %}badge-light{% endif %}" href="{{ request.path }}?entity_type=department&{{ request|query_transform(drop_keys=['entity_type']) }}"><i class="far fa-building"></i> Department</a>
            <a class="badge {% if 'entity_type' in request.GET and request.GET['entity_type'] == 'person' %}badge-primary{% else %}badge-light{% endif %}" href="{{ request.path }}?entity_type=person&{{ request|query_transform(drop_keys=['entity_type']) }}"><i class="far fa-address-card"></i> Person</a>
            <a class="badge {% if 'entity_type' not in request.GET %}badge-primary{% else %}badge-light{% endif %}" href="{{ request.path }}?{{ request|query_transform(drop_keys=['entity_type']) }}"><i class="fas fa-globe"></i> All</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    {% for entity, entity_facets in facets.items() %}
                        <strong>{{ entity }}</strong><br />
                        {% for facet_type, facet_values in entity_facets.items() %}
                            {% if facet_values %}
                                {% for facet in facet_values %}
                                    {{ facet }}<br />
                                    {% for x in facet_values[facet] %}
                                        {{ x }}<br />
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        <br />
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <tbody>
                            {% for result in results %}
                                <tr>
                                    <td>
                                        <a href="/{{ result.endpoint }}/{{ result.slug }}/">{{ result }}</a>
                                        <span class="badge badge-light">
                                            {% if result.endpoint == 'person' %}
                                                <i class="far fa-address-card"></i> Person
                                            {% elif result.endpoint == 'department' %}
                                                    <i class="far fa-building"></i> Department
                                            {% elif result.endpoint == 'unit' %}
                                                <i class="fas fa-building"></i> Unit
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% include 'partials/pagination.html' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    $('#entity-lookup').val('{{ request.GET.get("name", "") }}');

    $('#submit-button').click(function submitSearch(e) {
        e.preventDefault();

        var url;

        var params = {{ request.GET.dict()|safe }};

        if ( $('#entity-lookup').val() ) {
            params['name'] = $('#entity-lookup').val();
        }

        var querystring = $.param(params);

        if ( $('#entity-lookup').val() ) {
            url = '/search/?' + querystring;
        } else {
            url = '/search/';
        }

        window.location = url;
    });
</script>
{% endblock %}
