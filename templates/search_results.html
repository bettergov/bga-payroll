{% extends "base.html" %}

{% block title %}
    Search results
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">All</a></li>
        <li class="breadcrumb-item">Search</li>
    </ol>
</nav>

<div class="col-md-12">
    <div class="row">
        <div class="col">
            <h2>Search results: {{ request.GET.name or request.GET.entity_type or request.GET.employer|employer_from_slug }}</h2>
        </div>
    </div>

    <form id="entity-form">
        <div class="row">
            <div class="col-10">
                <input type="text" id="entity-lookup" class="form-control form-control-lg" placeholder="Chicago" />
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submit-button" style="width:100%;">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
    </form>

    <div class="row mb-3 mt-3">
        <div class="col">
            Filter by: <a class="badge {% if 'entity_type' in request.GET and request.GET['entity_type'] == 'unit' %}badge-primary{% else %}badge-light{% endif %}" href="{{ request.path }}?entity_type=unit&{{ request|query_transform(drop_keys=['entity_type']) }}"><i class="fas fa-building"></i> Unit</a>
            <a class="badge {% if 'entity_type' in request.GET and request.GET['entity_type'] == 'department' %}badge-primary{% else %}badge-light{% endif %}" href="{{ request.path }}?entity_type=department&{{ request|query_transform(drop_keys=['entity_type']) }}"><i class="far fa-building"></i> Department</a>
            <a class="badge {% if 'entity_type' in request.GET and request.GET['entity_type'] == 'person' %}badge-primary{% else %}badge-light{% endif %}" href="{{ request.path }}?entity_type=person&{{ request|query_transform(drop_keys=['entity_type']) }}"><i class="far fa-address-card"></i> Person</a>
            <a class="badge {% if 'entity_type' not in request.GET %}badge-primary{% else %}badge-light{% endif %}" href="{{ request.path }}?{{ request|query_transform(drop_keys=['entity_type']) }}"><i class="fas fa-globe"></i> All</a>
            <a class="badge" href="{{ request.path }}"><i class="fas fa-times"></i> Clear filters</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            {% for entity_type, entity_facets in facets.items() %}
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>{{ entity_type.title() }}</strong>
                    </div>
                    <ul class="list-group list-group-flush">
                        {% for facet, value_counts in entity_facets.items() %}
                            <li class="list-group-item">
                                {% with current_facet=facet.split(',')[0]|param_from_index %}
                                    <strong>{{ current_facet.title() }}</strong><br />

                                    {% for vc in value_counts %}
                                        <a href="/search/{{ vc['value']|url_from_facet(facet.split(',')[0]) }}">
                                            {% if current_facet in ('employer', 'parent') %}
                                                {{ vc.value|employer_from_slug }}
                                            {% elif current_facet in ('headcount', 'salary', 'expenditure') %}
                                                {{ vc.value|format_range }}
                                            {% else %}
                                                {{ vc.value }}
                                            {% endif %}
                                        </a>
                                        <span class="badge">{{ vc.count }}</span><br />

                                        {% if vc.get('pivot') %}
                                            {% for pc in vc.pivot %}
                                                {{ pc.value }}: {{ pc.count }}<br />
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                {% endwith %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <tbody>
                            {% for result in results %}
                                <tr>
                                    <td>
                                        {{ loop.index0 + page_obj.start_index() }}.
                                        {% include 'partials/search_result.html' %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% include 'partials/pagination.html' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    $('#entity-lookup').val('{{ request.GET.get("name", "") }}');

    $('#submit-button').click(function submitSearch(e) {
        e.preventDefault();

        var url;

        var params = {{ request.GET.dict()|safe }};

        if ( $('#entity-lookup').val() ) {
            params['name'] = $('#entity-lookup').val();
        }

        var querystring = $.param(params);

        if ( $('#entity-lookup').val() ) {
            url = '/search/?' + querystring;
        } else {
            url = '/search/';
        }

        window.location = url;
    });
</script>
{% endblock %}
