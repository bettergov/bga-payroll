{% extends "base.html" %}

{% block title %}
Uploads
{% endblock %}

{% block content %}

<div class="col-md-10 offset-md-1">

  <h2>Uploads</h2>

  <table class="table table-striped table-hover">
    <thead class="bg-warning">
      <tr>
        <th scope="col">Reporting Year</th>
        <th scope="col">Upload time</th>
        <th scope="col">Status</th>
        <th scope="col">Next step</th>
      </tr>
    </thead>
    <tbody>
      {% for upload in uploads %}
        {% with s_file = upload.standardized_file.get() %}
          <tr>
            <td>{{ s_file.reporting_year }}</td>
            <td>{{ upload.created_at.strftime('%Y-%m-%d %I:%M %p') }}</td>
            <td>{{ s_file.status.title() }}</td>
            <td>
              {% if s_file.status == 'uploaded' %}
                <a href="/data-import/review/responding-agency/{{ s_file.id }}">
                  Resume import &raquo;
                </a>
              {% endif %}
            </td>
          </tr>
        {% endwith %}
      {% endfor %}
    </tbody>
  </table>

</div>

{% include 'partials/pagination.html' %}
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    var stepSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/uploads/');

    stepSocket.onmessage = function(e) {
        // receive messages sent to channel
        var data = JSON.parse(e.data);
        console.log(data);
    };

    $(document).click(function() {
        // send upload ids to consumer for processing statuses
        stepSocket.send(JSON.stringify({
            'upload_ids': {{ upload_ids }},
        }));
    })
</script>
{% endblock %}