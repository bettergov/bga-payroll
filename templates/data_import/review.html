{% extends "base.html" %}

{% block title %}
Review
{% endblock %}

{% block extra_css %}
<link href="{{ static('css/jquery-ui.min.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="col-md-10 offset-md-1">
  <p class="lead">We found <strong>{{ items|length }}</strong> unmatched {{ entities }}.</p>

  <p>Click <span class="badge badge-dark">Match</span> to select an existing {{ entity }} or <span class="badge badge-success">Add</span> to create a new {{ entity }} in the database.</p>

  <table class="table table-striped table-hover">
    <tbody>
      {% for item in items %}
          <tr>
            {% for field in item %}
              <td class="align-middle">{{ field }}</td>
            {% endfor %}
            <td class="align-middle">
              <a class="btn btn-sm btn-dark text-light btn-match" data-toggle="modal" data-target="#matchModal" data-entity="{{ item[0] }}">Match</a>
            </td>
            <td class="align-middle">
              <a class="btn btn-sm btn-success text-light">Add</a>
            </td>
          </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="modal fade" id="matchModal" tabindex="-1" role="dialog" aria-labelledby="matchModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="matchModalLabel">Match</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body ui-front">
        <p>Select matching {{ entity }} for <strong id="selected-entity"></strong>.</p>

        <input type="text" class="form-control" id="autocomplete" data-entity-type="{{ entity.replace(' ', '-')}}">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="btn-match-submit">Match</button>
      </div>
    </div>
  </div>
</div>

{% include 'partials/pagination.html' %}
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="{{ static('js/lib/jquery-ui.min.js') }}"></script>
<script type="text/javascript">
  $('.btn-match').click(function fill_modal() {
      var entity = $(this).attr('data-entity');
      $('#selected-entity').text(entity);
  });

  var input = $('#autocomplete');

  input.autocomplete({
      source: '/data-import/lookup/' + input.attr('data-entity-type') + '/' + input.val(),
  });

  $('#btn-match-submit').click(function submit_match(){
    var params = $.param({
        's_file_id': {{ request.GET['s_file_id'] }},
        'enqueued': $('#selected-entity').text(),
        'existing': input.val(),
    })

    $.get(
        '/data-import/match/?' + params,
        success=function reload(resp){
            location.reload();
        },
    );
  });
</script>
{% endblock %}